<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ringmärkningsdata Sverige | NRM via GBIF</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --text: #e6edf3;
      --muted: #7d8590;
      --accent: #58a6ff;
      --green: #3fb950;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 1rem 1.5rem;
      background: var(--surface);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    h1 { font-size: 1.25rem; font-weight: 600; margin: 0; }
    .sub { font-size: 0.875rem; color: var(--muted); margin-top: 0.25rem; }
    .sub a { color: var(--accent); }
    main { display: flex; flex-direction: column; height: calc(100vh - 80px); }
    #map { flex: 1; min-height: 320px; }
    .panel {
      background: var(--surface);
      border-top: 1px solid rgba(255,255,255,.06);
      padding: 1rem 1.5rem;
      max-height: 220px;
      overflow: auto;
    }
    .panel h2 { font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; }
    .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-top: 0.5rem; font-size: 0.875rem; color: var(--muted); }
    .controls select { background: #111827; color: var(--text); border-radius: 4px; border: 1px solid rgba(255,255,255,.12); padding: 0.2rem 0.4rem; }
    .stats { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .stat { font-size: 1.125rem; }
    .stat strong { color: var(--green); }
    #species-list { font-size: 0.875rem; color: var(--muted); }
    #species-list span { margin-right: 0.75rem; }
    .loading { padding: 2rem; text-align: center; color: var(--muted); }
    .error { color: #f85149; }
    .fallback { margin-top: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,.05); border-radius: 6px; font-size: 0.875rem; }
    .fallback label { color: var(--accent); cursor: pointer; text-decoration: underline; }
    .fallback input[type="file"] { display: none; }
    .leaflet-popup-content { margin: 0.5rem 0.75rem; font-size: 0.8125rem; }
    .leaflet-popup-content strong { display: block; margin-bottom: 0.25rem; }
  </style>
</head>
<body>
  <header>
    <h1>Ringmärkningsdata Sverige</h1>
    <p class="sub">Naturhistoriska riksmuseet (Ringmärkningscentralen) via <a href="https://www.gbif.org/dataset/4f70108a-dda7-4e8b-8298-babaee5182c3" target="_blank" rel="noopener">GBIF</a>. Kartan visar ett urval händelser för ringmärkta fåglar i Sverige (ringmärkningar, återfångster, dödfynd m.m.) med art, datum och plats – men händelsetypen kan inte särskiljas i denna vy.</p>
    <div class="controls">
      <label for="region-filter">Område:</label>
      <select id="region-filter">
        <option value="">Hela Sverige</option>
      </select>
    </div>
  </header>
  <main>
    <div id="map"></div>
    <div class="panel">
      <h2>Översikt</h2>
      <div id="stats" class="stats"></div>
      <div id="species-list"></div>
    </div>
  </main>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    (function () {
      const mapEl = document.getElementById("map");
      const statsEl = document.getElementById("stats");
      const speciesEl = document.getElementById("species-list");
      const regionSelect = document.getElementById("region-filter");

      var svenskaArtnamn = {
        "Cyanistes caeruleus": "Blåmes",
        "Acanthis flammea": "Gråsiska",
        "Acanthis hornemanni": "Snösiska",
        "Accipiter gentilis": "Duvhök",
        "Aegithalos caudatus": "Stjärtmes",
        "Alauda arvensis": "Sånglärka",
        "Anas platyrhynchos": "Gräsand",
        "Ardea cinerea": "Gråhäger",
        "Asio flammeus": "Jorduggla",
        "Asio otus": "Hornuggla",
        "Aythya fuligula": "Vigg",
        "Bombycilla garrulus": "Sidensvans",
        "Bubo bubo": "Berguv",
        "Buteo buteo": "Ormvråk",
        "Carduelis carduelis": "Steglits",
        "Cercithia familiaris": "Trädkrypare",
        "Certhia familiaris": "Trädkrypare",
        "Cinclus cinclus": "Strömstare",
        "Chloris chloris": "Grönfink",
        "Coccothraustes coccothraustes": "Stenknäck",
        "Coloeus monedula": "Kaja",
        "Columba oenas": "Skogsduva",
        "Columba palumbus": "Ringduva",
        "Cygnus cygnus": "Sångsvan",
        "Cygnus olor": "Knölsvan",
        "Dendrocopos major": "Större hackspett",
        "Emberiza citrinella": "Gulsparv",
        "Erithacus rubecula": "Rödhake",
        "Fringilla coelebs": "Bofink",
        "Fringilla montifringilla": "Bergfink",
        "Fulica atra": "Sothöna",
        "Gallinago gallinago": "Enkelbeckasin",
        "Garrulus glandarius": "Nötskrika",
        "Glaucidium passerinum": "Pärluggla",
        "Lanius excubitor": "Varfågel",
        "Larus argentatus": "Gråtrut",
        "Larus canus": "Fiskmås",
        "Lophophanes cristatus": "Tofsmes",
        "Lymnocryptes minimus": "Dvärgbeckasin",
        "Melanitta nigra": "Sjöorre",
        "Nucifraga caryocatactes": "Nötkråka",
        "Parus major": "Talgoxe",
        "Passer domesticus": "Gråsparv",
        "Passer montanus": "Pilfink",
        "Periparus ater": "Svartmes",
        "Perisoreus infaustus": "Lavskrika",
        "Phylloscopus collybita": "Gransångare",
        "Pica pica": "Skata",
        "Picus canus": "Gråspett",
        "Poecile montanus": "Bergtita",
        "Poecile palustris": "Entita",
        "Prunella modularis": "Järnsparv",
        "Pyrrhula pyrrhula": "Domherre",
        "Regulus ignicapilla": "Brandkronad kungsfågel",
        "Regulus regulus": "Kungsfågel",
        "Scolopax rusticola": "Morkulla",
        "Sitta europaea": "Nötväcka",
        "Spinus spinus": "Grönsiska",
        "Strix aluco": "Kattuggla",
        "Surnia ulula": "Hökuggla",
        "Troglodytes troglodytes": "Gärdsmyg",
        "Turdus iliacus": "Rödvingetrast",
        "Turdus merula": "Koltrast",
        "Turdus pilaris": "Björktrast"
      };
      function svensktNamn(d) {
        if (d.vernacularName) return d.vernacularName;
        var sn = svenskaArtnamn[d.species || d.scientificName];
        return sn || null;
      }

      const map = L.map("map").setView([62.2, 15.5], 5);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution: "&copy; OpenStreetMap, &copy; CARTO",
      }).addTo(map);
      // Rita ut länsgränser (GeoJSON) ovanpå kartan – officiella Lantmäteriet/SCB via Opendatasoft
      fetch("https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/georef-sweden-lan/exports/geojson?lang=sv&timezone=Europe%2FStockholm")
        .then(function (r) { return r.ok ? r.json() : Promise.reject(new Error(r.statusText)); })
        .then(function (geo) {
          L.geoJSON(geo, {
            style: function () {
              return {
                color: "#4b5563",
                weight: 1,
                fillOpacity: 0.02
              };
            }
          }).addTo(map);
        })
        .catch(function (err) {
          console.error("Kunde inte ladda läns-GeoJSON:", err);
        });
      // Klustrade markörer så många fynd på samma plats syns som en klusterbubbla
      let markersLayer = L.markerClusterGroup({
        spiderfyOnEveryZoom: false,
        showCoverageOnHover: false,
        maxClusterRadius: 40
      });
      map.addLayer(markersLayer);
      let allData = [];
      let currentRegion = "";

      function render(data) {
        const withCoords = data.filter(function (d) {
          return d.decimalLatitude != null && d.decimalLongitude != null;
        });
        const byYear = {};
        const bySpecies = {};
        withCoords.forEach(function (d) {
          const y = d.year || "Okänt";
          byYear[y] = (byYear[y] || 0) + 1;
          const sp = d.species || d.scientificName || "Okänd";
          bySpecies[sp] = (bySpecies[sp] || 0) + 1;
        });

        statsEl.innerHTML =
          "<div class=\"stat\">Totalt <strong>" + withCoords.length + "</strong> poster med koordinater</div>" +
          "<div class=\"stat\">Antal arter: <strong>" + Object.keys(bySpecies).length + "</strong></div>";

        const topSpecies = Object.entries(bySpecies)
          .sort(function (a, b) { return b[1] - a[1]; })
          .slice(0, 15);
        speciesEl.innerHTML = "<span>Topp 15 arter (antal):</span> " +
          topSpecies.map(function (x) { return x[0] + " (" + x[1] + ")"; }).join(" · ");

        markersLayer.clearLayers();
        withCoords.forEach(function (d) {
          var vetenskap = d.species || d.scientificName || "—";
          var svenskt = svensktNamn(d);
          var namnRad = svenskt
            ? "<strong>" + svenskt + "</strong> <span style=\"color:var(--muted);font-size:0.9em\">(" + vetenskap + ")</span>"
            : "<strong>" + vetenskap + "</strong>";
          const popup = namnRad +
            (d.eventDate ? "<br>Datum: " + d.eventDate : "") +
            (d.locality ? "<br>Plats: " + d.locality : "") +
            (d.stateProvince ? " (" + d.stateProvince + ")" : "");
          L.marker([d.decimalLatitude, d.decimalLongitude])
            .bindPopup(popup)
            .addTo(markersLayer);
        });
        if (withCoords.length > 0) {
          const bounds = L.latLngBounds(withCoords.map(function (d) { return [d.decimalLatitude, d.decimalLongitude]; }));
          map.fitBounds(bounds, { padding: [24, 24], maxZoom: 10 });
        } else {
          map.setView([62.2, 15.5], 5);
        }
      }

      function applyFilter() {
        let data = allData;
        if (currentRegion) {
          data = allData.filter(function (d) { return (d.stateProvince || "") === currentRegion; });
        }
        render(data);
      }

      function initRegions(data) {
        const regions = Array.from(new Set(data.map(function (d) { return d.stateProvince; }).filter(Boolean))).sort();
        regions.forEach(function (r) {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = r;
          regionSelect.appendChild(opt);
        });
        regionSelect.addEventListener("change", function (e) {
          currentRegion = e.target.value || "";
          applyFilter();
        });
      }

      function onError(err) {
        console.error(err);
        statsEl.innerHTML =
          "<div class=\"error\">Kunde inte ladda data automatiskt (vanligt om du öppnat filen direkt från disken).</div>" +
          "<div class=\"fallback\">Välj fil manuellt: <label for=\"file-input\">Välj <code>data/occurrences.json</code></label> eller kör <code>python analysis/fetch_gbif.py</code> och öppna sidan via en lokal server (t.ex. <code>npx serve site</code>).<input type=\"file\" id=\"file-input\" accept=\"application/json,.json\" /></div>";
        speciesEl.innerHTML = "";
        document.getElementById("file-input").addEventListener("change", function (e) {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function () {
            try {
              const data = JSON.parse(reader.result);
              if (Array.isArray(data)) { render(data); return; }
              if (data && Array.isArray(data.results)) { render(data.results); return; }
              render([]);
            } catch (err2) {
              statsEl.innerHTML = "<div class=\"error\">Ogiltig JSON: " + err2.message + "</div>";
            }
          };
          reader.readAsText(file);
        });
      }

      fetch("data/occurrences.json")
        .then(function (r) { return r.ok ? r.json() : Promise.reject(new Error(r.statusText)); })
        .then(function (data) {
          if (Array.isArray(data)) return data;
          if (data && Array.isArray(data.results)) return data.results;
          return [];
        })
        .then(function (data) {
          allData = data;
          initRegions(allData);
          applyFilter();
        })
        .catch(onError);
    })();
  </script>
</body>
</html>
